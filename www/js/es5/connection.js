"use strict";System.register([],function(e,n){function o(e){if("synced"==g.state||"syncing"==g.state){if(E.readyState!=p.OPEN)return void(console&&console.warn("Attempting to send while socket closed"));e=JSON.stringify(e),y.DEBUG&&console.log("<",e),E.send(e)}}function t(e){y.DEBUG&&console.log(">",e.data);var n=JSON.parse(e.data)[0],o=n.shift(),t=n.shift(),c=f.is_pubsub(t);if(!c||"locked"!==g.state){var i=a.dispatcher[t];i&&(c&&o in m.syncs&&m.syncs[o]++,a.follow(function(){return i(n,o)}))}}function c(e){k.textContent=e}function i(){return E&&(E.onclose=null,E.onmessage=null),"file:"==window.location.protocol?void console.log("Page downloaded locally; refusing to sync."):(E=s(),E.onopen=g.feeder("open"),E.onclose=g.feeder("close"),E.onmessage=t,void(y.DEBUG&&(window.socket=E)))}function s(){var e=["xdr-streaming","xhr-streaming","iframe-eventsource","iframe-htmlfile","xdr-polling","xhr-polling","iframe-xhr-polling","jsonp-polling"];return y.USE_WEBSOCKETS&&e.unshift("websocket"),new p(y.SOCKET_URL||y.SOCKET_PATH,null,{transports:e})}function r(){h&&(clearTimeout(h),h=0),w=0}function l(){switch(g.state){case"desynced":return;case"synced":case"syncing":case"conn":var e=E.readyState;if(e!=p.OPEN&&e!=p.CONNECTING)return void g.feed("close");if(navigator.onLine===!1)return void g.feed("close")}g.feed("retry")}var d,a,u,f,y,g,m,p,v,E,w,h,k;return{setters:[],execute:function(){e("dispatcher",d={}),e("dispatcher",d),a=require("./main"),u=a._,f=a.common,y=a.config,g=a.connSM,m=a.state,p=a.SockJS,v=a.lang.sync,E=void 0,w=void 0,h=void 0,a.reply("send",o),k=document.getElementById("sync"),g.act("load + start -> conn",function(){c(v.connecting),w=0,i()}),g.act("conn, reconn + open -> syncing",function(){c(v.syncing);var e=f.randomID(32),n=m.page;n.set("connID",e),o([f.SYNCHRONIZE,e,n.get("board"),m.syncs,n.get("live"),document.cookie])}),g.act("syncing + sync -> synced",function(){c(v.synced),h=setTimeout(function(){h=0,r()},1e4)}),g.act("synced, syncing + lock -> locked"),g.act("locked + unlock -> synced"),a.reply("connection:lock",function(){return o([f.DESYNC])},g.feed("lock")),a.reply("connection:unlock",function(e){return o(e)},g.feed("unlock")),g.act("* + close -> dropped",function(e){E&&(E.onclose=null,E.onmessage=null),y.DEBUG&&console.error("E:",e),h&&(clearTimeout(h),h=0),c(v.dropped);var n=500*Math.pow(1.5,Math.min(Math.floor(++w/2),12));setTimeout(g.feeder("retry"),n)}),g.act("dropped + retry -> reconn",function(){i(),setTimeout(function(){"reconn"==g.state&&c(v.reconnecting)},100)}),g.act("* + invalid, desynced + close -> desynced",function(e){e=e&&e[0]?"Out of sync: "+e[0]:"Out of sync",c(e),h&&(clearTimeout(h),h=0),E.onclose=null,E.onmessage=null,E.close(),E=null,y.DEBUG&&(window.socket=null)}),g.feed("start"),document.addEventListener("visibilitychange",function(e){e.target.hidden||setTimeout(l,20)}),window.addEventListener("online",function(){return r()},g.feed("retry")),window.addEventListener("offline",g.feeder("close"))}}});
//# sourceMappingURL=maps/connection.js.map
