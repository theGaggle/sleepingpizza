"use strict";System.register([],function(e,t){var s,r,i,o,a,n,c,h,d,u,l,m,g,p;return{setters:[],execute:function(){s=require("./main"),r=s.$,i=s.$script,o=s._,a=s.Backbone,n=s.common,c=s.lang,h=s.config.RECAPTCHA_PUBLIC_KEY,d=3e5,u=c.reports,l={},m=void 0,g=a.Model.extend({defaults:{status:"setup",hideAfter:!0},request_new:function(){var e=this;Recaptcha.create(h,"captcha",{theme:"clean",callback:function(){return e.set("status","ready")}}),this.get("timeout")&&clearTimeout(this.get("timeout")),this.set("timeout",setTimeout(function(){e.set("timeout",0),e.request_new()},d))},did_report:function(){var e=this;delete l[this.id],this.get("timeout")&&(clearTimeout(this.get("timeout")),this.set("timeout",0)),setTimeout(function(){return e.trigger("destroy")},1500),this.get("hideAfter")&&this.get("post").set("hide",!0)}}),p=a.View.extend({id:"report-panel",tagName:"form",className:"modal",events:{submit:"submit","click .close":"remove","click .hideAfter":"hide_after_changed"},initialize:function(){this.$captcha=r('<div id="captcha"/>'),this.$message=r('<div class="message"/>'),this.$submit=r("<input>",{type:"submit",val:"Report"});var e=r("<input>",{"class":"hideAfter",type:"checkbox",checked:this.model.get("hideAfter")}),t=r("<label>and hide</label>").append(e),i=this.model.get("post").get("num");this.$el.append(u.post+" ",s.oneeSama.postRef(i),'<a class="close" href="#">x</a>',this.$message,this.$captcha,this.$submit," ",t),window.x_csrf&&(this.model.set("hideAfter",!1),t.remove()),this.listenTo(this.model,{"change:error":this.error_changed,"change:status":this.status_changed,destroy:this.remove})},render:function(){return this.error_changed(),this.status_changed(),this},submit:function(){return"ready"!=this.model.get("status")?!1:(s.send([n.REPORT_POST,parseInt(this.model.get("post").get("num"),10),Recaptcha.get_challenge(),Recaptcha.get_response()]),this.model.set("status","reporting"),!1)},error_changed:function(){this.$message.text(this.model.get("error"))},status_changed:function(){var e=this.model.get("status");this.$submit.prop("disabled","ready"!=e).toggle("done"!==e).val("reporting"===e?u.reporting:c.report),this.$captcha.toggle(o.contains(["ready","reporting","error"],e)),"done"===e&&this.$("label").remove();var t=void 0;"done"===e?t=u.submitted:"setup"==e?t=u.setup:("error"==e||"ready"==e&&this.model.get("error"))&&(t="E"),this.$message.text("E"===t?this.model.get("error"):t),this.$message.toggle(!!t).toggleClass("error","E"==t),"ready"==e?this.focus():"done"==e?this.model.did_report():"error"==e&&this.model.request_new()},hide_after_changed:function(e){this.model.set("hideAfter",e.target.checked)},focus:function(){Recaptcha.focus_response_field()},remove:function(){return a.View.prototype.remove.call(this),m===this&&(m=null,Recaptcha.destroy()),!1}}),s.reply("report",function(e){var t="https://www.google.com/recaptcha/api/js/recaptcha_ajax.js";i(t,function(){var t=e.get("num"),s=l[t];if(s||(l[t]=s=new g({id:t,post:e})),m){if(m.model===s)return void m.focus();m.remove()}m=new p({model:s}),m.render().$el.appendTo("body"),window.Recaptcha?s.request_new():s.set({status:"error",error:u.loadError})})}),s.dispatcher[n.REPORT_POST]=function(e){var t=l[e[0]];t&&t.set(e[1]||{status:"done"})}}}});
//# sourceMappingURL=maps/report.js.map
