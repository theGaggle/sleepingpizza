{"version":3,"sources":["posts/render/body.js"],"names":["System","register","_export","_context","parseWord","word","data","split","html","i","length","state","bit","test","parsePostLink","links","parseReference","parseURL","escape","num","match","verified","renderPostLink","board","OP","name","href","refTargets","newTabLink","text","encodeURI","config","_slicedToArray","boards","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_iterator2","_step2","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_iterator3","_step3","_step3$value","link","setters","_state","_underscore","_etc","execute","renderBody","renderFragment","body","dice","frag","lines","line","startsWith","_iteratorNormalCompletion","_didIteratorError","_iteratorError","undefined","_step","_iterator","Symbol","iterator","next","done","value","err","sliceIterator","arr","_arr","_n","_d","_e","_s","_i","push","Array","isArray","Object","TypeError","enabled","psuedo","concat"],"mappings":"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","file":"posts/render/body.js","sourcesContent":["import {config} from '../state'\nimport {escape} from 'underscore'\nimport {renderPostLink} from './etc'\n\n// Render the text body of a post\nexport function renderBody(data) {\n\tif (!data.state) {\n\t\t// Initial post state [new_line, no_qoute, no_spoiler, no_dice]\n\t\tdata.state = [0, 0, 0]\n\t}\n\tlet html = renderFragment(data.body, data.state, data.dice)\n\tif (data.state[1]) { // Close quote on post end\n\t\thtml += '</em>'\n\t}\n\tif (data.state[2]) { // Same with spoilers\n\t\thtml += '</del>'\n\t}\n\treturn html\n}\n\n// Parse commited text body fragment\nexport function renderFragment(frag, data) {\n\tconst lines = frag.split('\\n'),\n\t\t{state} = data\n\tlet html = ''\n\tfor (let i = 0; i < lines.length; i++) {\n\t\t// Start a new line\n\t\tif (state[0] && i % 2) {\n\t\t\t// Close quoute\n\t\t\tif (state[1] % 2) {\n\t\t\t\thtml += '</em>'\n\t\t\t\tstate[1]++\n\t\t\t}\n\t\t\thtml += '<br>'\n\t\t\tstate[0] = 0\n\t\t}\n\n\t\t// Quote or line starts with link/embed\n\t\tconst line = lines[i]\n\t\tif (!state[0] && line.startsWith('>')) {\n\t\t\thtml += '<em>'\n\t\t\tstate[1]++\n\t\t}\n\n\t\t// Bodies may be empty\n\t\tif (frag) {\n\t\t\tfor (let word of line.split(' ')) {\n\t\t\t\thtml += parseWord(word, data)\n\t\t\t\tstate[0] = 1\n\t\t\t}\n\t\t}\n\t}\n\treturn html\n}\n\n// Convert a word to it's appropriate HTML representation\nfunction parseWord(word, data) {\n\t// `[spoiler]` and `[/spoiler]` are treated the same way. You can't nest\n\t// them.\n\tconst split = word.split(/\\[\\/?spoiler]/i)\n\tlet html = ''\n\tfor (let i = 0; i < split.length; i++) {\n\t\t// Insert spoiler tags\n\t\tif (i % 2) {\n\t\t\thtml += `<${data.state[2]++ % 2 ? '/' : ''}del>`\n\n\t\t\t// TODO: Do we need special logic for postForms here?\n\t\t}\n\n\t\tconst bit = split[i]\n\t\tif (/^>>\\d+$/.test(bit)) {\n\t\t\t// Post links\n\t\t\thtml += parsePostLink(bit, data.links)\n\t\t} else if (/^>>>\\/\\w+\\//.test(bit)) {\n\t\t\t// Internal and custom reference URLs\n\t\t\thtml += parseReference(bit)\n\t\t} else if (/^https?:\\/\\/[^-A-Za-z0-9+&@#/%?=~_]$/.test(bit)) {\n\t\t\t// Generic URLs\n\t\t\thtml += parseURL(bit)\n\t\t} else if (/<strong>.+<\\/strong>/.test(bit)) {\n\t\t\t// Hash command results. Already verified server-side.\n\t\t\thtml += bit\n\t\t} else {\n\t\t\thtml += escape(bit)\n\t\t}\n\t}\n\treturn html\n}\n\n// Verify and render a link to other posts\nfunction parsePostLink(bit, links) {\n\tif (!links) {\n\t\treturn bit\n\t}\n\tconst num = bit.match(/^>>\\/(\\d+)$/)[1],\n\t\tverified = links[num]\n\tif (!verified) {\n\t\treturn bit\n\t}\n\treturn renderPostLink(num, verified.board, verified.OP)\n}\n\n// Generate all possible refference name and link pairs\nconst refTargets = {},\n\t{boards} = config\nfor (let board of boards.enabled) {\n\trefTargets[board] = `../${board}/`\n}\nfor (let [name, link] of boards.psuedo.concat(boards.links)) {\n\trefTargets[name] = link\n}\n\n// Parse internal or customly set reference URL\nfunction parseReference(bit) {\n\tconst name = bit.match(/^>>>\\/(\\w+)\\/$/)[1],\n\t\thref = refTargets[name]\n\tif (!href) {\n\t\treturn bit\n\t}\n\treturn newTabLink(href, bit)\n}\n\n// Render and anchor link that opens in a new tab\nfunction newTabLink(href, text) {\n\treturn `<a href=\"${href}\" target=\"_blank\">${text}</a>`\n}\n\n// Render generic URLs and embed, if aplicable\nfunction parseURL(bit) {\n\n\t// TODO: Embeds\n\n\treturn newTabLink(encodeURI(href), bit)\n}\n"],"sourceRoot":"/source/"}