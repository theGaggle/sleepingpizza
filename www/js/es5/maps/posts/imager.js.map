{"version":3,"sources":["posts/imager.js"],"names":["System","register","_export","_context","_taggedTemplateLiteral","strings","raw","Object","freeze","defineProperties","value","_classCallCheck","instance","Constructor","TypeError","_possibleConstructorReturn","self","call","ReferenceError","_inherits","subClass","superClass","prototype","create","constructor","enumerable","writable","configurable","setPrototypeOf","__proto__","View","$threads","_templateObject","_templateObject2","Imager","ExpanderModel","massExpander","setters","_view","_state","execute","_View","args","this","getPrototypeOf","exports","Hidamari","Backbone","extend","renderImage","arg","image","manual","reveal","model","el","src","get","figure","query","remove","before","util","parseDOM","oneeSama","window","scrollTop","getBoundingClientRect","top","document","body","height","set","thumbnailRevealed","imageExpanded","tallImage","autoExpandImage","img","indexOf","ext","toggleImageExpansion","expand","fit","options","fitImage","open","imagePaths","renderAudio","newWidth","undefined","newHeight","width","dims","expandImage","both","widthFlag","heightFlag","aspect","fullWidth","fullHeight","maxWidth","imageMaxWidth","maxHeight","innerHeight","offsetHeight","innerWidth","parseInt","closest","left","outerWidth","noMargin","isVideo","attrs","cls","autoplay","loop","controls","lastChild","innerHTML","common","parseHTML","append","Model","initialize","_this2","on","e","preventDefault","toggle","massToggle","find","text","main","lang","expander","models","state","posts","i","l","length","dispatch","reply","unset","which","getModel","target","request","follow"],"mappings":"AAAA,YAAaA,QAAOC,UAAU,UAAU,YAAY,SAASC,EAAQC,GAA+F,QAASC,GAAuBC,EAAQC,GAAK,MAAOC,QAAOC,OAAOD,OAAOE,iBAAiBJ,GAASC,KAAKI,MAAMH,OAAOC,OAAOF,OAAU,QAASK,GAAgBC,EAASC,GAAa,KAAKD,YAAoBC,IAAc,KAAM,IAAIC,WAAU,qCAAuC,QAASC,GAA2BC,EAAKC,GAAM,IAAID,EAAM,KAAM,IAAIE,gBAAe,4DAA8D,QAAOD,GAAqB,gBAAPA,IAA+B,kBAAPA,GAAwBD,EAALC,EAAW,QAASE,GAAUC,EAASC,GAAY,GAAuB,kBAAbA,IAAsC,OAAbA,EAAmB,KAAM,IAAIP,WAAU,iEAAkEO,GAAaD,GAASE,UAAUf,OAAOgB,OAAOF,GAAYA,EAAWC,WAAWE,aAAad,MAAMU,EAASK,YAAW,EAAMC,UAAS,EAAKC,cAAa,KAAWN,IAAWd,OAAOqB,eAAerB,OAAOqB,eAAeR,EAASC,GAAYD,EAASS,UAAUR,GAA7/B,GAAIS,GAAKC,EAASC,EAAgBC,EAAiBC,EAAOC,EAAcC,CAAi8B,QAAQC,SAAS,SAASC,GAAOR,EAAKQ,EAAAA,YAAgB,SAASC,GAAQR,EAASQ,EAAOR,WAAYS,QAAQ,WAAWR,EAAgB5B,GAAwB,IAAI,IAAI,MAAM,IAAI,IAAI,MAAM6B,EAAiB7B,GAAwB,eAAe,wFAA0G,eAAe,wFAA0G8B,EAAO,SAASO,GAA+B,QAASP,GAAOQ,GAAmC,MAA7B/B,GAAgBgC,KAAKT,GAAenB,EAA2B4B,KAAKpC,OAAOqC,eAAeV,GAAQjB,KAAK0B,KAAKD,IAAQ,MAAlKvB,GAAUe,EAAOO,GAAwJP,GAASJ,GAAMe,QAAQC,SAASC,SAASjB,KAAKkB,QAAQC,YAAY,SAAqBC,EAAIC,EAAMC,GAAQ,GAAIC,GAAOH,KAAM,EAASI,EAAMX,KAAKW,MAAUC,EAAGZ,KAAKY,EAAOJ,IAAQA,EAAMK,MAAIL,EAAMG,EAAMG,IAAI,SAAS,IAAIC,GAAOH,EAAGI,MAAM,SAAaD,IAAOA,EAAOE,SAAaT,IAAaI,EAAGI,MAAM,cAAcE,OAAOC,KAAKC,SAASC,SAASb,MAAMA,EAAME,KAAaD,GAAQE,EAAMG,IAAI,eAAcQ,OAAOC,UAAUX,EAAGY,wBAAwBC,IAAIC,SAASC,KAAKJ,UAAUG,SAASV,MAAM,WAAWY,QAAQjB,EAAMkB,KAAKC,kBAAkBpB,EAAOqB,eAAc,EAAMC,WAAU,MAAUC,gBAAgB,WAA2B,GAAIC,GAAIlC,KAAKW,MAAMG,IAAI,QAAS,QAAIoB,IAAMzC,EAAaqB,IAAI,YAAY,QAAQ,OAAO,QAAQqB,QAAQD,EAAIE,KAAK,GAAUpC,MAAKA,KAAKqC,sBAAqB,EAAKH,GAAYlC,OAAOqC,qBAAqB,SAA8BC,EAAOJ,EAAIzB,GAAQ,GAAI8B,GAAIC,QAAQ1B,IAAI,YAAiBoB,IAAW,SAANK,IAAuBD,EAAOtC,KAAKyC,SAASP,EAAIK,GAAUvC,KAAKM,YAAY,KAAK4B,EAAIzB,KAAUgC,SAAS,SAAkBP,EAAIK,GAAK,GAAa,SAAVL,EAAIE,IAAa,MAAOd,QAAOoB,KAAKrB,SAASsB,aAAa9B,IAAIqB,EAAIrB,IAAI,SAAU,IAAa,SAAVqB,EAAIE,IAAa,MAAOpC,MAAK4C,YAAYV,EAAK,IAAIW,GAASC,OAAUC,EAAUD,OAAUE,EAAMH,EAASX,EAAIe,KAAK,GAAGrB,EAAOmB,EAAUb,EAAIe,KAAK,EAAG,IAAS,SAANV,EAAa,MAAOvC,MAAKkD,YAAYhB,GAAKc,MAAMA,EAAMpB,OAAOA,GAAS,IAAIuB,GAAW,SAANZ,EAAaa,EAAUD,GAAY,UAANZ,EAAcc,EAAWF,GAAY,WAANZ,EAAee,EAAON,EAAMpB,EAAW2B,EAAUT,OAAUU,EAAWV,MAAU,IAAGM,EAAU,CAAC,GAAIK,GAASzD,KAAK0D,eAAmBb,GAASY,IAAUZ,EAASY,EAASV,EAAUF,EAASS,EAAOC,GAAU,GAAO,GAAGF,EAAW,CAAC,GAAIM,GAAUrC,OAAOsC,YAAYlC,SAASV,MAAM,WAAW6C,YAAgBd,GAAUY,IAAWZ,EAAUY,EAAUd,EAASE,EAAUO,EAAOE,GAAW,GAAUX,EAAS,IAAIE,EAAU,KAAIC,EAAMH,EAASjB,EAAOmB,GAAW/C,KAAKkD,YAAYhB,EAAIc,EAAMpB,EAAO4B,IAAaD,IAAaG,cAAc,WAAyB,GAAI9C,GAAGZ,KAAKY,GAAOD,EAAMX,KAAKW,KAAM,OAAOW,QAAOwC,WAAwE,EAA7DC,SAASnD,EAAGoD,QAAQ,WAAWxC,wBAAwByC,MAAQ9C,KAAK+C,WAAWvD,EAAMG,IAAI,MAAMF,EAAGA,EAAGI,MAAM,iBAAkBkC,YAAY,SAAqBhB,EAAIc,EAAMpB,EAAOuC,GAAU,GAAIC,GAAkB,UAAVlC,EAAIE,IAAkBiC,GAAOxD,IAAIQ,SAASsB,aAAa9B,IAAIqB,EAAIrB,IAAImC,MAAMA,EAAMpB,OAAOA,GAAY0C,EAAI,UAAcH,KAASG,GAAK,aAAYD,EAAAA,SAAYC,EAAOF,IAAQC,EAAME,SAASF,EAAMG,KAAKH,EAAMI,UAAS,GAAKzE,KAAKY,GAAGI,MAAM,UAAU0D,UAAUC,UAAUC,OAAOC,UAAUxF,EAAgB+E,EAAQ,QAAQ,MAAMC,GAAOrE,KAAKW,MAAMkB,KAAKE,eAAc,EAAKC,UAAUJ,EAAON,OAAOsC,eAAgBhB,YAAY,SAAqBV,GAAKlC,KAAKY,GAAGI,MAAM,UAAU8D,OAAO3D,KAAKC,SAASwD,OAAOC,UAAUvF,EAAiB+B,SAASsB,aAAa9B,IAAIqB,EAAIrB,OAAOb,KAAKW,MAAMkB,IAAI,iBAAgB,MAAUrC,EAAcY,SAAS2E,MAAM1E,QAAQ2E,WAAW,WAAsB,GAAIC,GAAOjF,IAAKZ,GAAS8F,GAAG,QAAQ,gBAAgB,SAASC,GAAGA,EAAEC,iBAAiBH,EAAOI,YAAcA,OAAO,WAAkB,GAAI/C,IAAQtC,KAAKc,IAAI,SAAUd,MAAK6B,IAAI,SAASS,GAAQgD,WAAWhD,GAAQlD,EAASmG,KAAK,iBAAiBC,KAAKC,KAAKC,KAAKC,UAAUrD,KAAWgD,WAAW,SAAoBhD,GAAQ,GAAIC,GAAIC,QAAQ1B,IAAI,YAAa,IAAS,SAANyB,EAAkD,IAAI,GAA9BqD,GAAOC,MAAMC,MAAMF,OAAeG,EAAE,EAAEC,EAAEJ,EAAOK,OAASD,EAAFD,EAAIA,IAAI,CAAC,GAAIpF,GAAMiF,EAAOG,GAAG7D,EAAIvB,EAAMG,IAAI,QAAaoB,KAAgBI,EAAO3B,EAAMuF,SAAS,WAAWhE,EAAIK,GAAU5B,EAAMuF,SAAS,cAAc,KAAKhE,QAAUzC,EAAaS,QAAQT,aAAa,GAAID,GAAgBiG,KAAKU,MAAM,qBAAqB,WAAW,MAAO1G,GAAa2G,UAAWhH,EAAS8F,GAAG,QAAQ,aAAa,SAASC,GAAG,GAA6B,QAA1B3C,QAAQ1B,IAAI,cAAgC,IAAVqE,EAAEkB,MAAvC,CAAwD,GAAI1F,GAAMQ,KAAKmF,SAASnB,EAAEoB,OAAY5F,KAAawE,EAAEC,iBAAiBK,KAAKe,QAAQ,kBAAkB7F,EAAMuF,SAAS,wBAAwBvF,EAAMG,IAAI,iBAAiBH,EAAMG,IAAI,UAAS,OAAS1B,EAAS8F,GAAG,QAAQ,eAAe,SAASC,GAAGA,EAAEC,gBAAiB,IAAIzE,GAAMQ,KAAKmF,SAASnB,EAAEoB,OAAY5F,IAAa8E,KAAKgB,OAAO,WAAW,MAAO9F,GAAMuF,SAAS,eAAevF,EAAMG,IAAI","file":"posts/imager.js","sourcesContent":["'use strict';System.register(['../view','../state'],function(_export,_context){var View,$threads,_templateObject,_templateObject2,Imager,ExpanderModel,massExpander;function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}));}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError(\"Cannot call a class as a function\");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");}return call&&(typeof call===\"object\"||typeof call===\"function\")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!==\"function\"&&superClass!==null){throw new TypeError(\"Super expression must either be null or a function, not \"+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}return {setters:[function(_view){View=_view.default;},function(_state){$threads=_state.$threads;}],execute:function(){_templateObject=_taggedTemplateLiteral(['<',' ','>'],['<',' ','>']);_templateObject2=_taggedTemplateLiteral(['<audio src=\"','\"\\n\\t\\t\\t\\twidth=\"300\"\\n\\t\\t\\t\\theight=\"3em\"\\n\\t\\t\\t\\tautoplay loop controls\\n\\t\\t\\t>\\n\\t\\t\\t</audio>'],['<audio src=\"','\"\\n\\t\\t\\t\\twidth=\"300\"\\n\\t\\t\\t\\theight=\"3em\"\\n\\t\\t\\t\\tautoplay loop controls\\n\\t\\t\\t>\\n\\t\\t\\t</audio>']);Imager=function(_View){_inherits(Imager,_View);function Imager(args){_classCallCheck(this,Imager);return _possibleConstructorReturn(this,Object.getPrototypeOf(Imager).call(this,args));}return Imager;}(View);exports.Hidamari=Backbone.View.extend({renderImage:function renderImage(arg,image,manual){var reveal=arg===true;var model=this.model;var el=this.el;if(!image||!image.src)image=model.get('image');var figure=el.query('figure');if(figure)figure.remove();if(!image)return;el.query('blockquote').before(util.parseDOM(oneeSama.image(image,reveal)));if(manual&&model.get('tallImage')){window.scrollTop=el.getBoundingClientRect().top+document.body.scrollTop-document.query('#banner').height;}model.set({thumbnailRevealed:reveal,imageExpanded:false,tallImage:false});},autoExpandImage:function autoExpandImage(){var img=this.model.get('image');if(!img||!massExpander.get('expand')||['.webm','.pdf','.mp3'].indexOf(img.ext)>-1)return this;this.toggleImageExpansion(true,img);return this;},toggleImageExpansion:function toggleImageExpansion(expand,img,manual){var fit=options.get('inlinefit');if(!img||fit==='none')return;if(expand)this.fitImage(img,fit);else this.renderImage(null,img,manual);},fitImage:function fitImage(img,fit){if(img.ext==='.pdf')return window.open(oneeSama.imagePaths().src+img.src,'_blank');if(img.ext==='.mp3')return this.renderAudio(img);var newWidth=undefined,newHeight=undefined,width=newWidth=img.dims[0],height=newHeight=img.dims[1];if(fit==='full')return this.expandImage(img,{width:width,height:height});var both=fit==='both',widthFlag=both||fit==='width',heightFlag=both||fit==='height',aspect=width/height;var fullWidth=undefined,fullHeight=undefined;if(widthFlag){var maxWidth=this.imageMaxWidth();if(newWidth>maxWidth){newWidth=maxWidth;newHeight=newWidth/aspect;fullWidth=true;}}if(heightFlag){var maxHeight=window.innerHeight-document.query('#banner').offsetHeight;if(newHeight>maxHeight){newHeight=maxHeight;newWidth=newHeight*aspect;fullHeight=true;}}if(newWidth>50&&newHeight>50){width=newWidth;height=newHeight;}this.expandImage(img,width,height,fullHeight&&!fullWidth);},imageMaxWidth:function imageMaxWidth(){var el=this.el;var model=this.model;return window.innerWidth-parseInt(el.closest('section').getBoundingClientRect().left)*2-util.outerWidth(model.get('op')?el:el.query('.background'));},expandImage:function expandImage(img,width,height,noMargin){var isVideo=img.ext==='.webm';var attrs={src:oneeSama.imagePaths().src+img.src,width:width,height:height};var cls='expanded';if(noMargin)cls+=' noMargin';attrs.class=cls;if(isVideo)attrs.autoplay=attrs.loop=attrs.controls=true;this.el.query('figure').lastChild.innerHTML=common.parseHTML(_templateObject,isVideo?'video':'img',attrs);this.model.set({imageExpanded:true,tallImage:height>window.innerHeight});},renderAudio:function renderAudio(img){this.el.query('figure').append(util.parseDOM(common.parseHTML(_templateObject2,oneeSama.imagePaths().src+img.src)));this.model.set('imageExpanded',true);}});ExpanderModel=Backbone.Model.extend({initialize:function initialize(){var _this2=this;$threads.on('click','#expandImages',function(e){e.preventDefault();_this2.toggle();});},toggle:function toggle(){var expand=!this.get('expand');this.set('expand',expand).massToggle(expand);$threads.find('#expandImages').text(main.lang.expander[+expand]);},massToggle:function massToggle(expand){var fit=options.get('inlinefit');if(fit==='none')return;var models=state.posts.models;for(var i=0,l=models.length;i<l;i++){var model=models[i],img=model.get('image');if(!img)continue;if(expand)model.dispatch('fitImage',img,fit);else model.dispatch('renderImage',null,img);}}});massExpander=exports.massExpander=new ExpanderModel();main.reply('massExpander:unset',function(){return massExpander.unset();});$threads.on('click','img, video',function(e){if(options.get('inlinefit')=='none'||e.which!==1)return;var model=util.getModel(e.target);if(!model)return;e.preventDefault();main.request('imager:clicked');model.dispatch('toggleImageExpansion',!model.get('imageExpanded'),model.get('image'),true);});$threads.on('click','.imageToggle',function(e){e.preventDefault();var model=util.getModel(e.target);if(!model)return;main.follow(function(){return model.dispatch('renderImage',!model.get('thumbnailRevealed'));});});}};});"],"sourceRoot":"/source/"}