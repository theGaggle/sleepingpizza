{"version":3,"sources":["report.js"],"names":["System","register","_export","_context","main","$","$script","_","Backbone","common","lang","pubKey","captchaTimeout","repLang","reports","panel","Report","ReportPanel","setters","execute","require","config","RECAPTCHA_PUBLIC_KEY","undefined","Model","extend","defaults","status","hideAfter","request_new","_this","this","Recaptcha","create","theme","callback","set","get","clearTimeout","setTimeout","did_report","_this2","id","trigger","View","tagName","className","events","submit","click .close","click .hideAfter","initialize","$captcha","$message","$submit","type","val","$hideAfter","class","checked","model","$hideLabel","append","num","$el","post","oneeSama","postRef","window","x_csrf","remove","listenTo","change:error","error_changed","change:status","status_changed","destroy","render","send","REPORT_POST","parseInt","get_challenge","get_response","text","prop","toggle","reporting","report","contains","msg","submitted","setup","toggleClass","focus","hide_after_changed","e","target","focus_response_field","prototype","call","reply","url","appendTo","error","loadError","dispatcher"],"mappings":"AAAA,YAAaA,QAAOC,YAAY,SAASC,EAAQC,GAAU,GAAIC,GAAKC,EAAEC,EAAQC,EAAEC,EAASC,EAAOC,EAAKC,EAAOC,EAAeC,EAAQC,EAAQC,EAAMC,EAAOC,CAAY,QAAQC,WAAWC,QAAQ,WAAWf,EAAKgB,QAAQ,UAAUf,EAAED,EAAKC,EAAEC,EAAQF,EAAKE,QAAQC,EAAEH,EAAKG,EAAEC,EAASJ,EAAKI,SAASC,EAAOL,EAAKK,OAAOC,EAAKN,EAAKM,KAAKC,EAAOP,EAAKiB,OAAOC,qBAAqBV,EAAe,IAAUC,EAAQH,EAAKI,QAAQA,KAAWC,EAAMQ,OAAUP,EAAOR,EAASgB,MAAMC,QAAQC,UAAUC,OAAO,QAAQC,WAAU,GAAMC,YAAY,WAAuB,GAAIC,GAAMC,IAAKC,WAAUC,OAAOtB,EAAO,WAAWuB,MAAM,QAAQC,SAAS,WAAoB,MAAOL,GAAMM,IAAI,SAAS,YAAgBL,KAAKM,IAAI,YAAWC,aAAaP,KAAKM,IAAI,YAAYN,KAAKK,IAAI,UAAUG,WAAW,WAAWT,EAAMM,IAAI,UAAU,GAAGN,EAAMD,eAAgBjB,KAAmB4B,WAAW,WAAsB,GAAIC,GAAOV,WAAYjB,GAAQiB,KAAKW,IAAOX,KAAKM,IAAI,aAAYC,aAAaP,KAAKM,IAAI,YAAYN,KAAKK,IAAI,UAAU,IAAIG,WAAW,WAAW,MAAOE,GAAOE,QAAQ,YAAa,MAASZ,KAAKM,IAAI,cAAaN,KAAKM,IAAI,QAAQD,IAAI,QAAO,MAAUnB,EAAYT,EAASoC,KAAKnB,QAAQiB,GAAG,eAAeG,QAAQ,OAAOC,UAAU,QAAQC,QAAQC,OAAO,SAASC,eAAe,SAASC,mBAAmB,sBAAsBC,WAAW,WAAsBpB,KAAKqB,SAAS/C,EAAE,uBAAuB0B,KAAKsB,SAAShD,EAAE,0BAA0B0B,KAAKuB,QAAQjD,EAAE,WAAWkD,KAAK,SAASC,IAAI,UAAW,IAAIC,GAAWpD,EAAE,WAAWqD,QAAM,YAAYH,KAAK,WAAWI,QAAQ5B,KAAK6B,MAAMvB,IAAI,eAAmBwB,EAAWxD,EAAE,2BAA2ByD,OAAOL,GAAgBM,EAAIhC,KAAK6B,MAAMvB,IAAI,QAAQA,IAAI,MAAON,MAAKiC,IAAIF,OAAOjD,EAAQoD,KAAK,IAAI7D,EAAK8D,SAASC,QAAQJ,GAAK,kCAAkChC,KAAKsB,SAAStB,KAAKqB,SAASrB,KAAKuB,QAAQ,IAAIO,GAAeO,OAAOC,SAAQtC,KAAK6B,MAAMxB,IAAI,aAAY,GAAOyB,EAAWS,UAAUvC,KAAKwC,SAASxC,KAAK6B,OAAOY,eAAezC,KAAK0C,cAAcC,gBAAgB3C,KAAK4C,eAAeC,QAAQ7C,KAAKuC,UAAWO,OAAO,WAA6D,MAA3C9C,MAAK0C,gBAAgB1C,KAAK4C,iBAAwB5C,MAAOiB,OAAO,WAAkB,MAA6B,SAA1BjB,KAAK6B,MAAMvB,IAAI,WAA0B,GAAMjC,EAAK0E,MAAMrE,EAAOsE,YAAYC,SAASjD,KAAK6B,MAAMvB,IAAI,QAAQA,IAAI,OAAO,IAAIL,UAAUiD,gBAAgBjD,UAAUkD,iBAAiBnD,KAAK6B,MAAMxB,IAAI,SAAS,cAAoB,IAAQqC,cAAc,WAAyB1C,KAAKsB,SAAS8B,KAAKpD,KAAK6B,MAAMvB,IAAI,WAAYsC,eAAe,WAA0B,GAAIhD,GAAOI,KAAK6B,MAAMvB,IAAI,SAAUN,MAAKuB,QAAQ8B,KAAK,WAAmB,SAARzD,GAAiB0D,OAAgB,SAAT1D,GAAiB6B,IAAa,cAAT7B,EAAqBd,EAAQyE,UAAU5E,EAAK6E,QAAQxD,KAAKqB,SAASiC,OAAO9E,EAAEiF,UAAU,QAAQ,YAAY,SAAS7D,IAAqB,SAATA,GAAgBI,KAAK1B,EAAE,SAASiE,QAAS,IAAImB,GAAIlE,MAAsB,UAATI,EAAgB8D,EAAI5E,EAAQ6E,UAA0B,SAAR/D,EAAgB8D,EAAI5E,EAAQ8E,OAAsB,SAARhE,GAAyB,SAARA,GAAiBI,KAAK6B,MAAMvB,IAAI,YAASoD,EAAI,KAAI1D,KAAKsB,SAAS8B,KAAW,MAANM,EAAU1D,KAAK6B,MAAMvB,IAAI,SAASoD,GAAK1D,KAAKsB,SAASgC,SAASI,GAAKG,YAAY,QAAa,KAALH,GAAqB,SAAR9D,EAAgBI,KAAK8D,QAAwB,QAARlE,EAAeI,KAAK6B,MAAMpB,aAA6B,SAARb,GAAgBI,KAAK6B,MAAM/B,eAAgBiE,mBAAmB,SAA4BC,GAAGhE,KAAK6B,MAAMxB,IAAI,YAAY2D,EAAEC,OAAOrC,UAAWkC,MAAM,WAAiB7D,UAAUiE,wBAAyB3B,OAAO,WAA6G,MAA3F9D,GAASoC,KAAKsD,UAAU5B,OAAO6B,KAAKpE,MAAShB,IAAQgB,OAAMhB,EAAM,KAAKiB,UAAU4C,YAAkB,KAAUxE,EAAKgG,MAAM,SAAS,SAASnC,GAAM,GAAIoC,GAAI,2DAA4D/F,GAAQ+F,EAAI,WAAW,GAAItC,GAAIE,EAAK5B,IAAI,OAAWuB,EAAM9C,EAAQiD,EAAmE,IAA1DH,IAAO9C,EAAQiD,GAAKH,EAAM,GAAI5C,IAAQ0B,GAAGqB,EAAIE,KAAKA,KAAWlD,EAAM,CAAC,GAAGA,EAAM6C,QAAQA,EAAqB,WAAd7C,GAAM8E,OAAgB9E,GAAMuD,SAAUvD,EAAM,GAAIE,IAAa2C,MAAMA,IAAQ7C,EAAM8D,SAASb,IAAIsC,SAAS,QAAWlC,OAAOpC,UAAU4B,EAAM/B,cAAoB+B,EAAMxB,KAAKT,OAAO,QAAQ4E,MAAM1F,EAAQ2F,gBAAmBpG,EAAKqG,WAAWhG,EAAOsE,aAAa,SAASU,GAAK,GAAIF,GAAOzE,EAAQ2E,EAAI,GAAOF,IAAOA,EAAOnD,IAAIqD,EAAI,KAAK9D,OAAO","file":"report.js","sourcesContent":["'use strict';System.register([],function(_export,_context){var main,$,$script,_,Backbone,common,lang,pubKey,captchaTimeout,repLang,reports,panel,Report,ReportPanel;return {setters:[],execute:function(){main=require('./main');$=main.$;$script=main.$script;_=main._;Backbone=main.Backbone;common=main.common;lang=main.lang;pubKey=main.config.RECAPTCHA_PUBLIC_KEY;captchaTimeout=5*60*1000;repLang=lang.reports;reports={};panel=undefined;Report=Backbone.Model.extend({defaults:{status:'setup',hideAfter:true},request_new:function request_new(){var _this=this;Recaptcha.create(pubKey,'captcha',{theme:'clean',callback:function callback(){return _this.set('status','ready');}});if(this.get('timeout'))clearTimeout(this.get('timeout'));this.set('timeout',setTimeout(function(){_this.set('timeout',0);_this.request_new();},captchaTimeout));},did_report:function did_report(){var _this2=this;delete reports[this.id];if(this.get('timeout')){clearTimeout(this.get('timeout'));this.set('timeout',0);}setTimeout(function(){return _this2.trigger('destroy');},1500);if(this.get('hideAfter'))this.get('post').set('hide',true);}});ReportPanel=Backbone.View.extend({id:'report-panel',tagName:'form',className:'modal',events:{submit:'submit','click .close':'remove','click .hideAfter':'hide_after_changed'},initialize:function initialize(){this.$captcha=$('<div id=\"captcha\"/>');this.$message=$('<div class=\"message\"/>');this.$submit=$('<input>',{type:'submit',val:'Report'});var $hideAfter=$('<input>',{class:'hideAfter',type:'checkbox',checked:this.model.get('hideAfter')});var $hideLabel=$('<label>and hide</label>').append($hideAfter);var num=this.model.get('post').get('num');this.$el.append(repLang.post+' ',main.oneeSama.postRef(num),'<a class=\"close\" href=\"#\">x</a>',this.$message,this.$captcha,this.$submit,' ',$hideLabel);if(window.x_csrf){this.model.set('hideAfter',false);$hideLabel.remove();}this.listenTo(this.model,{'change:error':this.error_changed,'change:status':this.status_changed,destroy:this.remove});},render:function render(){this.error_changed();this.status_changed();return this;},submit:function submit(){if(this.model.get('status')!='ready')return false;main.send([common.REPORT_POST,parseInt(this.model.get('post').get('num'),10),Recaptcha.get_challenge(),Recaptcha.get_response()]);this.model.set('status','reporting');return false;},error_changed:function error_changed(){this.$message.text(this.model.get('error'));},status_changed:function status_changed(){var status=this.model.get('status');this.$submit.prop('disabled',status!='ready').toggle(status!=='done').val(status==='reporting'?repLang.reporting:lang.report);this.$captcha.toggle(_.contains(['ready','reporting','error'],status));if(status==='done')this.$('label').remove();var msg=undefined;if(status==='done')msg=repLang.submitted;else if(status=='setup')msg=repLang.setup;else if(status=='error'||status=='ready'&&this.model.get('error'))msg='E';this.$message.text(msg==='E'?this.model.get('error'):msg);this.$message.toggle(!!msg).toggleClass('error',msg=='E');if(status=='ready')this.focus();else if(status=='done')this.model.did_report();else if(status=='error')this.model.request_new();},hide_after_changed:function hide_after_changed(e){this.model.set('hideAfter',e.target.checked);},focus:function focus(){Recaptcha.focus_response_field();},remove:function remove(){Backbone.View.prototype.remove.call(this);if(panel===this){panel=null;Recaptcha.destroy();}return false;}});main.reply('report',function(post){var url='https://www.google.com/recaptcha/api/js/recaptcha_ajax.js';$script(url,function(){var num=post.get('num');var model=reports[num];if(!model){reports[num]=model=new Report({id:num,post:post});}if(panel){if(panel.model===model){panel.focus();return;}panel.remove();}panel=new ReportPanel({model:model});panel.render().$el.appendTo('body');if(window.Recaptcha)model.request_new();else {model.set({status:'error',error:repLang.loadError});}});});main.dispatcher[common.REPORT_POST]=function(msg){var report=reports[msg[0]];if(report)report.set(msg[1]||{status:'done'});};}};});"],"sourceRoot":"/source/"}