{"version":3,"sources":["notify.js"],"names":["System","register","_export","_context","main","$","_","Backbone","config","connSM","etc","state","options","discoFavicon","xhr","NotifyModel","notify","replies","setters","execute","require","XMLHttpRequest","open","responseType","onload","this","status","window","URL","createObjectURL","response","send","Model","extend","initialize","_this","$favicon","check","listenTo","reply","model","get","document","hidden","set","title","addEventListener","e","target","unreadCount","dropped","on","_model$attributes","attributes","alert","icon","render","prefix","attr","Memory","num","post","posts","readAll","isMobile","n","Notification","lang","quoted","image","oneeSama","workMode","thumbPath","body","onclick","focus","location","hash","write","syncwatchStarting"],"mappings":"AAAA,YAAaA,QAAOC,YAAY,SAASC,EAAQC,GAAU,GAAIC,GAAKC,EAAEC,EAAEC,EAASC,EAAOC,EAAOC,EAAIC,EAAMC,EAAQC,EAAaC,EAAIC,EAAYC,EAAOC,CAAQ,QAAQC,WAAWC,QAAQ,WAAWf,EAAKgB,QAAQ,UAAUf,EAAED,EAAKC,EAAEC,EAAEF,EAAKE,EAAEC,EAASH,EAAKG,SAASC,EAAOJ,EAAKI,OAAOC,EAAOL,EAAKK,OAAOC,EAAIN,EAAKM,IAAIC,EAAMP,EAAKO,MAAMC,EAAQR,EAAKQ,QAAQC,EAAa,GAAGC,EAAI,GAAIO,gBAAiBP,EAAIQ,KAAK,MAAM,gCAAgCR,EAAIS,aAAa,OAAOT,EAAIU,OAAO,WAA4B,MAAdC,KAAKC,SAAab,EAAac,OAAOC,IAAIC,gBAAgBJ,KAAKK,YAAYhB,EAAIiB,OAAOhB,EAAYR,EAASyB,MAAMC,QAAQC,WAAW,WAAsB,GAAIC,GAAMV,IAAKA,MAAKW,SAAS/B,EAAE,YAAYoB,KAAKY,MAAMZ,MAAMA,KAAKa,SAASb,KAAK,SAASA,KAAKY,OAAOjC,EAAKmC,MAAM,gBAAgB,SAASC,GAAUA,EAAMC,IAAI,SAAkBC,SAASC,QAAOR,EAAMS,IAAI,cAAcT,EAAMM,IAAI,eAAe,KAAMrC,EAAKmC,MAAM,eAAe,SAASM,GAAO,MAAOV,GAAMS,IAAI,QAAQC,KAAUH,SAASI,iBAAiB,mBAAmB,SAASC,GAAG,GAAIJ,GAAOI,EAAEC,OAAOL,MAAOR,GAAMS,KAAKD,OAAOA,EAAOM,YAAY,EAAEV,OAAOI,MAAW,EAAO,IAAIO,GAAQ,WAAmB,MAAOf,GAAMS,IAAI,SAAQ,GAAQnC,GAAO0C,GAAG,UAAUD,GAASzC,EAAO0C,GAAG,WAAWD,GAASzC,EAAO0C,GAAG,SAAS,WAAW,MAAOnC,GAAO4B,IAAI,SAAQ,MAAYP,MAAM,SAAeG,GAAO,GAAIY,GAAkBZ,EAAMa,WAAeV,EAAOS,EAAkBT,OAAWM,EAAYG,EAAkBH,YAAgBV,EAAMa,EAAkBb,MAAUe,EAAMF,EAAkBE,MAAUC,EAAK,kBAAmB,IAAGD,EAAM,MAAO7B,MAAK+B,OAAO3C,EAAa,OAAa,KAAI8B,EAAO,MAAOlB,MAAK+B,OAAOD,EAAK,GAAI,IAAIE,GAAO,EAAMR,KAAaQ,GAAQ,IAAIR,EAAY,KAAKM,EAAK,iCAAoChB,IAAOkB,EAAO,MAAMA,EAAOF,EAAK,gCAAgC9B,KAAK+B,OAAOD,EAAKE,IAAUD,OAAO,SAAgBD,EAAKE,GAAQf,SAASG,MAAMY,EAAOhC,KAAKgB,IAAI,SAAShB,KAAKW,SAASsB,KAAK,OAAOH,MAAUvC,EAAO,GAAID,IAAakC,YAAY,EAAEJ,MAAMH,SAASG,QAAQ5B,EAAQ,GAAIb,GAAKuD,OAAO,UAAU,GAAGvD,EAAKmC,MAAM,cAAc,SAASqB,GAAK,GAAIC,GAAKlD,EAAMmD,MAAMrB,IAAImB,EAAK,IAAIC,IAAYA,EAAKA,EAAKR,aAAcO,IAAO3C,GAAQ8C,YAAlB,CAAmC,GAAGnD,EAAQ6B,IAAI,iBAAiBC,SAASC,SAASvC,EAAK4D,SAAS,CAAC,GAAIC,GAAE,GAAIC,cAAa9D,EAAK+D,KAAKC,QAAQb,KAAKM,EAAKQ,OAA+B,SAAxBzD,EAAQ6B,IAAI,YAAqBrC,EAAKkE,SAASC,SAASnE,EAAKkE,SAASE,UAAUX,EAAKQ,OAAO,yBAAyBI,KAAKZ,EAAKY,MAAOR,GAAES,QAAQ,WAAW/C,OAAOgD,QAAQC,SAASC,KAAK,KAAKjB,GAAO5C,EAAO4B,KAAKL,OAAM,IAAOtB,EAAQ6D,MAAMlB,MAAQxD,EAAKmC,MAAM,iBAAiB,WAAe3B,EAAQ6B,IAAI,iBAAkBC,SAASC,SAAc,GAAIuB,cAAa9D,EAAK+D,KAAKY,mBAAmBL,QAAQ,WAAW,MAAO/C,QAAOgD","file":"notify.js","sourcesContent":["'use strict';System.register([],function(_export,_context){var main,$,_,Backbone,config,connSM,etc,state,options,discoFavicon,xhr,NotifyModel,notify,replies;return {setters:[],execute:function(){main=require('./main');$=main.$;_=main._;Backbone=main.Backbone;config=main.config;connSM=main.connSM;etc=main.etc;state=main.state;options=main.options;discoFavicon='';xhr=new XMLHttpRequest();xhr.open('GET','/ass/css/ui/disconnected.ico');xhr.responseType='blob';xhr.onload=function(){if(this.status===200)discoFavicon=window.URL.createObjectURL(this.response);};xhr.send();NotifyModel=Backbone.Model.extend({initialize:function initialize(){var _this=this;this.$favicon=$('#favicon');this.check(this);this.listenTo(this,'change',this.check);main.reply('post:inserted',function(model){if(model.get('mine'))return;if(document.hidden)_this.set('unreadCount',_this.get('unreadCount')+1);});main.reply('notify:title',function(title){return _this.set('title',title);});document.addEventListener('visibilitychange',function(e){var hidden=e.target.hidden;_this.set({hidden:hidden,unreadCount:0,reply:!hidden});},false);var dropped=function dropped(){return _this.set('alert',true);};connSM.on('dropped',dropped);connSM.on('desynced',dropped);connSM.on('synced',function(){return notify.set('alert',false);});},check:function check(model){var _model$attributes=model.attributes;var hidden=_model$attributes.hidden;var unreadCount=_model$attributes.unreadCount;var reply=_model$attributes.reply;var alert=_model$attributes.alert;var icon='/ass/favicon.ico';if(alert)return this.render(discoFavicon,'--- ');else if(!hidden)return this.render(icon,'');var prefix='';if(unreadCount){prefix+='('+unreadCount+') ';icon='/ass/css/ui/unreadFavicon.ico';}if(reply){prefix='>> '+prefix;icon='/ass/css/ui/replyFavicon.ico';}this.render(icon,prefix);},render:function render(icon,prefix){document.title=prefix+this.get('title');this.$favicon.attr('href',icon);}});notify=new NotifyModel({unreadCount:0,title:document.title});replies=new main.Memory('replies',3);main.reply('repliedToMe',function(num){var post=state.posts.get(num);if(!post)return;post=post.attributes;if(num in replies.readAll())return;if(options.get('notification')&&document.hidden&&!main.isMobile){var n=new Notification(main.lang.quoted,{icon:post.image&&options.get('thumbs')!=='hide'&&!main.oneeSama.workMode?main.oneeSama.thumbPath(post.image):'/ass/css/ui/favbig.png',body:post.body});n.onclick=function(){window.focus();location.hash='#p'+num;};}notify.set({reply:true});replies.write(num);});main.reply('time:syncwatch',function(){if(!options.get('notification')||!document.hidden)return;new Notification(main.lang.syncwatchStarting).onclick=function(){return window.focus();};});}};});"],"sourceRoot":"/source/"}