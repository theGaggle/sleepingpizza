{"version":3,"sources":["connection.js"],"names":["System","register","_export","_context","send","msg","connSM","state","socket","readyState","SockJS","OPEN","console","warn","JSON","stringify","config","DEBUG","log","on_message","e","data","parse","op","shift","type","isPubSub","common","is_pubsub","handler","main","dispatcher","syncs","follow","sync_status","sync","textContent","connect","onclose","onmessage","window","location","protocol","new_socket","onopen","feeder","transports","USE_WEBSOCKETS","unshift","SOCKET_URL","SOCKET_PATH","reset_attempts","attemptTimer","clearTimeout","attempts","window_focused","rs","CONNECTING","feed","navigator","onLine","_","lang","setters","execute","require","undefined","reply","document","getElementById","act","connecting","syncing","connID","randomID","page","set","SYNCHRONIZE","get","cookie","synced","setTimeout","DESYNC","error","dropped","wait","Math","pow","min","floor","reconnecting","close","addEventListener","target","hidden"],"mappings":"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","file":"connection.js","sourcesContent":["'use strict';System.register([],function(_export,_context){var dispatcher,main,_,common,config,connSM,state,SockJS,lang,socket,attempts,attemptTimer,sync;function send(msg){if(connSM.state!='synced'&&connSM.state!='syncing')return;if(socket.readyState!=SockJS.OPEN){if(console)console.warn(\"Attempting to send while socket closed\");return;}msg=JSON.stringify(msg);if(config.DEBUG)console.log('<',msg);socket.send(msg);}function on_message(e){if(config.DEBUG)console.log('>',e.data);var msg=JSON.parse(e.data)[0],op=msg.shift(),type=msg.shift(),isPubSub=common.is_pubsub(type);if(isPubSub&&connSM.state==='locked')return;var handler=main.dispatcher[type];if(!handler)return;if(isPubSub&&op in state.syncs)state.syncs[op]++;main.follow(function(){return handler(msg,op);});}function sync_status(msg){sync.textContent=msg;}function connect(){if(socket){socket.onclose=null;socket.onmessage=null;}if(window.location.protocol=='file:'){console.log(\"Page downloaded locally; refusing to sync.\");return;}socket=new_socket();socket.onopen=connSM.feeder('open');socket.onclose=connSM.feeder('close');socket.onmessage=on_message;if(config.DEBUG)window.socket=socket;}function new_socket(){var transports=['xdr-streaming','xhr-streaming','iframe-eventsource','iframe-htmlfile','xdr-polling','xhr-polling','iframe-xhr-polling','jsonp-polling'];if(config.USE_WEBSOCKETS)transports.unshift('websocket');return new SockJS(config.SOCKET_URL||config.SOCKET_PATH,null,{transports:transports});}function reset_attempts(){if(attemptTimer){clearTimeout(attemptTimer);attemptTimer=0;}attempts=0;}function window_focused(){switch(connSM.state){case 'desynced':return;case 'synced':case 'syncing':case 'conn':var rs=socket.readyState;if(rs!=SockJS.OPEN&&rs!=SockJS.CONNECTING){connSM.feed('close');return;}else if(navigator.onLine===false){connSM.feed('close');return;}break;}connSM.feed('retry');}return {setters:[],execute:function(){_export('dispatcher',dispatcher={});_export('dispatcher',dispatcher);main=require('./main');_=main._;common=main.common;config=main.config;connSM=main.connSM;state=main.state;SockJS=main.SockJS;lang=main.lang.sync;socket=undefined;attempts=undefined;attemptTimer=undefined;main.reply('send',send);sync=document.getElementById('sync');connSM.act('load + start -> conn',function(){sync_status(lang.connecting);attempts=0;connect();});connSM.act('conn, reconn + open -> syncing',function(){sync_status(lang.syncing);var connID=common.randomID(32);var page=state.page;page.set('connID',connID);send([common.SYNCHRONIZE,connID,page.get('board'),state.syncs,page.get('live'),document.cookie]);});connSM.act('syncing + sync -> synced',function(){sync_status(lang.synced);attemptTimer=setTimeout(function(){attemptTimer=0;reset_attempts();},10000);});connSM.act('synced, syncing + lock -> locked');connSM.act('locked + unlock -> synced');main.reply('connection:lock',function(){return send([common.DESYNC]);},connSM.feed('lock'));main.reply('connection:unlock',function(msg){return send(msg);},connSM.feed('unlock'));connSM.act('* + close -> dropped',function(error){if(socket){socket.onclose=null;socket.onmessage=null;}if(config.DEBUG)console.error('E:',error);if(attemptTimer){clearTimeout(attemptTimer);attemptTimer=0;}sync_status(lang.dropped);var wait=500*Math.pow(1.5,Math.min(Math.floor(++attempts/2),12));setTimeout(connSM.feeder('retry'),wait);});connSM.act('dropped + retry -> reconn',function(){connect();setTimeout(function(){if(connSM.state=='reconn')sync_status(lang.reconnecting);},100);});connSM.act('* + invalid, desynced + close -> desynced',function(msg){msg=msg&&msg[0]?'Out of sync: '+msg[0]:'Out of sync';sync_status(msg);if(attemptTimer){clearTimeout(attemptTimer);attemptTimer=0;}socket.onclose=null;socket.onmessage=null;socket.close();socket=null;if(config.DEBUG)window.socket=null;});connSM.feed('start');document.addEventListener('visibilitychange',function(e){if(e.target.hidden)return;setTimeout(window_focused,20);});window.addEventListener('online',function(){return reset_attempts();},connSM.feed('retry'));window.addEventListener('offline',connSM.feeder('close'));}};});"],"sourceRoot":"/source/"}